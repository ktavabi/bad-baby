---
title: "Random Effects"
author: "Kambiz Tavabi"
date: "2/6/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown
```{r}
rm(list = ls())
set.seed(5432)

J <- 15
N <- 30
test.df <- data.frame(unit = sort(rep(c(1:N), J)),
                      J = rep(c(1:J), N) ,
                      x = rnorm(n = J * N))
beta <- 3 + .2 * rnorm(N)

test.df$beta <- beta[test.df$unit]
test.df$y <- 1 + test.df$x * test.df$beta + .75 * rnorm(n = J * N)
head(test.df, 18)
```

## Separate regressions
```{r}
beta.hat <- list()
for (i in 1:N) {
    unit.lm <- lm(y ~ x, data = subset(test.df, unit == i))
    beta.hat[i] <- coef(unit.lm)[2]
}
beta.hat <- as.numeric(beta.hat)
```

```{r}
par(mfrow = c(2, 1))
hist(
    beta,
    main = "Histogram of Actual Slopes",
    col = "blue",
    xlab = expression(beta[i]),
    cex.axis = 1.5,
    cex.lab = 1.5,
    breaks = seq(from = 2.4, to = 3.6, by = .1)
)
hist(
    as.numeric(beta.hat),
    main = "Histogram of Estimated Slopes",
    xlab = expression(hat(beta)[i]),
    col = "blue",
    cex.axis = 1.5,
    cex.lab = 1.5,
    breaks = seq(from = 2.4, to = 3.6, by = .1)
)
```

## Random effects modeling using lme4
Random effects are specified as:
_(formula for random terms | unit for which these terms apply)_
Starting on the left side of the bar, the formula for:

* A random intercept, by itself, is simply “1”. 
* The formula for a random regression coeficient for a variable x, without the corresponding random intercept, is “0 + x”.  
* Random intercepts are included by default, so “x” and “1 + x” are equivalent specifications of both a random slope and a random intercept.

```{r}
library(lme4)
re.lm1 <- lmer(y ~ x + (1+x|unit), data = test.df) 
summary(re.lm1)
```

_lmer()_ $y = \alpha_i + \beta_i * x_{ij}$ without random intercept for _x_
```{r}
re.lm0 <- lmer(y ~ x + (0+x|unit), data = test.df) 
summary(re.lm0)
```

```{r}
anova(re.lm1, re.lm0)
```

